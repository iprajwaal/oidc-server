<div class="card">
    <div style="text-align: center;">
        <span class="icon" style="font-size: 48px; color: var(--md-sys-color-primary);">lock_person</span>
        <h1 class="headline-medium" style="margin-top: 16px;">Sign in</h1>
        <p class="body-medium">to continue to <b>{{#if client_id}}{{client_id}}{{else}}OIDC Server{{/if}}</b></p>
    </div>

    {{#if error}}
    <div class="error-banner">
        <span class="icon">error</span>
        {{error}}
    </div>
    {{/if}}

    <form action="/login" method="post" id="login-form">
        <input type="hidden" name="client_id" value="{{client_id}}">
        <input type="hidden" name="redirect_uri" value="{{redirect_uri}}">
        <input type="hidden" name="state" value="{{state}}">
        <input type="hidden" name="scope" value="{{scope}}">
        <input type="hidden" name="code_challenge" value="{{code_challenge}}">
        <input type="hidden" name="code_challenge_method" value="{{code_challenge_method}}">

        <div class="form-group">
            <div class="text-field">
                <input type="text" name="username" id="username" placeholder=" " required>
                <label for="username">Username</label>
            </div>
        </div>

        <div class="form-group">
            <div class="text-field">
                <input type="password" name="password" id="password" placeholder=" " required>
                <label for="password">Password</label>
            </div>
        </div>

        <button type="submit" class="btn btn-primary btn-full">
            Sign in
        </button>
    </form>

    <div class="divider">or</div>

    <button id="btn-passkey-login" class="btn btn-tonal btn-full">
        <span class="icon">fingerprint</span>
        Sign in with Passkey
    </button>
    <p id="passkey-message" class="body-medium"
        style="text-align: center; min-height: 20px; color: var(--md-sys-color-primary);"></p>
</div>

<script>
    const { startAuthentication } = SimpleWebAuthnBrowser;
    const messageEl = document.getElementById('passkey-message');

    document.getElementById('btn-passkey-login').addEventListener('click', async () => {
        messageEl.innerText = 'Authenticating...';

        try {
            const resp = await fetch('/webauthn/login/options');
            const options = await resp.json();

            const asseResp = await startAuthentication(options);

            const verificationResp = await fetch('/webauthn/login/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(asseResp),
            });

            const verificationJSON = await verificationResp.json();

            if (verificationJSON && verificationJSON.verified) {
                messageEl.innerText = 'Success!';

                const params = new URLSearchParams({
                    client_id: '{{client_id}}',
                    redirect_uri: '{{redirect_uri}}',
                    state: '{{state}}',
                    scope: '{{scope}}',
                    code_challenge: '{{code_challenge}}',
                    code_challenge_method: '{{code_challenge_method}}',
                    response_type: 'code'
                });

                window.location.href = `/authorize?${params.toString()}`;
            } else {
                messageEl.innerText = 'Failed.';
                console.error(verificationJSON);
            }
        } catch (error) {
            messageEl.innerText = 'Error occurred.';
            console.error(error);
        }
    });
</script>